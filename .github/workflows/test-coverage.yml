name: Test Coverage

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  backend-coverage:
    name: Backend Test Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest pytest-cov pytest-asyncio

      - name: Run tests with coverage
        run: |
          pytest tests/ \
            --cov=tkr_docusearch \
            --cov-report=html \
            --cov-report=json \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-fail-under=70 \
            -v

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-reports
          path: |
            htmlcov/
            coverage.json
            coverage.xml
          retention-days: 30

      - name: Coverage Summary
        if: always()
        run: |
          echo "## Backend Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Coverage threshold: 70%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage.json ]; then
            python -c "
          import json
          with open('coverage.json') as f:
              data = json.load(f)
              totals = data.get('totals', {})
              print(f\"Lines: {totals.get('percent_covered', 0):.2f}%\")
              print(f\"Statements: {totals.get('num_statements', 0)}\")
              print(f\"Missing: {totals.get('missing_lines', 0)}\")
          " >> $GITHUB_STEP_SUMMARY
          fi

  frontend-coverage:
    name: Frontend Test Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run tests with coverage
        working-directory: ./frontend
        run: npm run test:ci

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage-reports
          path: |
            frontend/coverage/
          retention-days: 30

      - name: Coverage Summary
        if: always()
        working-directory: ./frontend
        run: |
          echo "## Frontend Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Coverage threshold: 70%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage/coverage-summary.json ]; then
            node -e "
          const fs = require('fs');
          const summary = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
          const totals = summary.total;
          console.log(\`Lines: \${totals.lines.pct}%\`);
          console.log(\`Statements: \${totals.statements.pct}%\`);
          console.log(\`Functions: \${totals.functions.pct}%\`);
          console.log(\`Branches: \${totals.branches.pct}%\`);
          " >> $GITHUB_STEP_SUMMARY
          fi

  coverage-report:
    name: Combined Coverage Report
    runs-on: ubuntu-latest
    needs: [backend-coverage, frontend-coverage]
    if: always()

    steps:
      - name: Download backend coverage
        uses: actions/download-artifact@v7
        with:
          name: backend-coverage-reports
          path: backend-coverage
        continue-on-error: true

      - name: Download frontend coverage
        uses: actions/download-artifact@v7
        with:
          name: frontend-coverage-reports
          path: frontend-coverage
        continue-on-error: true

      - name: Generate combined summary
        run: |
          echo "# Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Coverage reports generated for both backend and frontend." >> $GITHUB_STEP_SUMMARY
          echo "Minimum threshold: **70%** for all metrics." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See individual job outputs for detailed coverage information." >> $GITHUB_STEP_SUMMARY
