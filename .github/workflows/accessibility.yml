name: Accessibility Testing

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  accessibility:
    name: WCAG 2.1 AA Compliance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Install pa11y globally
        run: npm install -g pa11y pa11y-ci

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build

      - name: Start preview server
        working-directory: ./frontend
        run: |
          npm run preview &
          echo "PREVIEW_PID=$!" >> $GITHUB_ENV
          # Wait for server to be ready
          npx wait-on http://localhost:4173 -t 30000

      - name: Run pa11y accessibility tests
        run: |
          echo "## Accessibility Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Standard: **WCAG 2.1 Level AA**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Test main pages
          URLS=(
            "http://localhost:4173"
            "http://localhost:4173/about"
          )

          TOTAL_ISSUES=0
          for url in "${URLS[@]}"; do
            echo "Testing: $url" >> $GITHUB_STEP_SUMMARY

            # Run pa11y and capture results
            if pa11y "$url" --standard WCAG2AA --reporter cli > pa11y_output.txt 2>&1; then
              echo "✅ No issues found" >> $GITHUB_STEP_SUMMARY
            else
              ISSUES=$(grep -c "Error" pa11y_output.txt || echo "0")
              TOTAL_ISSUES=$((TOTAL_ISSUES + ISSUES))
              echo "❌ Found $ISSUES accessibility issues" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "<details>" >> $GITHUB_STEP_SUMMARY
              echo "<summary>View Issues</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              cat pa11y_output.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          done

          # Summary
          echo "---" >> $GITHUB_STEP_SUMMARY
          if [ $TOTAL_ISSUES -eq 0 ]; then
            echo "## ✅ Accessibility Tests Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All tested pages comply with WCAG 2.1 Level AA standards." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ❌ Accessibility Issues Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Total issues: $TOTAL_ISSUES" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review and fix the issues listed above." >> $GITHUB_STEP_SUMMARY
            kill $PREVIEW_PID 2>/dev/null || true
            exit 1
          fi

      - name: Stop preview server
        if: always()
        run: kill $PREVIEW_PID 2>/dev/null || true

  lighthouse:
    name: Lighthouse Accessibility Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Install Lighthouse
        run: npm install -g @lhci/cli@0.13.x lighthouse

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build

      - name: Start preview server
        working-directory: ./frontend
        run: |
          npm run preview &
          echo "PREVIEW_PID=$!" >> $GITHUB_ENV
          npx wait-on http://localhost:4173 -t 30000

      - name: Run Lighthouse CI
        run: |
          echo "## Lighthouse Accessibility Score" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Run Lighthouse
          lighthouse http://localhost:4173 \
            --only-categories=accessibility \
            --chrome-flags="--headless --no-sandbox" \
            --output=json \
            --output-path=./lighthouse-results.json

          # Extract accessibility score
          SCORE=$(node -p "JSON.parse(require('fs').readFileSync('./lighthouse-results.json', 'utf8')).categories.accessibility.score * 100")

          echo "Accessibility Score: **${SCORE}/100**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if score meets threshold (90+)
          if (( $(echo "$SCORE >= 90" | bc -l) )); then
            echo "✅ Meets minimum threshold (90+)" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Below minimum threshold (90+)" >> $GITHUB_STEP_SUMMARY
            kill $PREVIEW_PID 2>/dev/null || true
            exit 1
          fi

      - name: Upload Lighthouse results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-results
          path: lighthouse-results.json
          retention-days: 30

      - name: Stop preview server
        if: always()
        run: kill $PREVIEW_PID 2>/dev/null || true

  accessibility-report:
    name: Accessibility Report
    runs-on: ubuntu-latest
    needs: [accessibility, lighthouse]
    if: always()

    steps:
      - name: Generate combined summary
        run: |
          echo "# Accessibility Testing Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.accessibility.result }}" == "success" ] && [ "${{ needs.lighthouse.result }}" == "success" ]; then
            echo "## ✅ All Accessibility Tests Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The application meets accessibility standards:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ WCAG 2.1 Level AA compliance (pa11y)" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ Lighthouse accessibility score ≥ 90" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "See individual job outputs for detailed results." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ❌ Accessibility Test Failures" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            [ "${{ needs.accessibility.result }}" != "success" ] && echo "- ❌ WCAG 2.1 compliance test failed" >> $GITHUB_STEP_SUMMARY
            [ "${{ needs.lighthouse.result }}" != "success" ] && echo "- ❌ Lighthouse accessibility score below threshold" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review and fix the issues before merging." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
