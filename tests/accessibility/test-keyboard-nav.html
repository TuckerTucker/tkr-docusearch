<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keyboard Navigation Test - Accessibility</title>
    <link rel="stylesheet" href="../../src/frontend/styles/accessibility.css">
    <link rel="stylesheet" href="../../src/frontend/styles/highlighting-animations.css">
    <style>
        /* Test page specific styles */
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: oklch(0.9582 0.0152 90.2357);
        }

        .test-section {
            margin: 40px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        h1, h2, h3 {
            color: oklch(0.3760 0.0225 64.3434);
        }

        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        /* Mock chunk styles */
        [data-chunk-id] {
            padding: 16px;
            margin: 8px 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Mock bbox styles */
        .bbox-overlay {
            position: relative;
            width: 100%;
            height: 400px;
            border: 2px solid #ddd;
            border-radius: 4px;
            background: #f5f5f5;
        }

        .bbox-rect {
            cursor: pointer;
            fill: oklch(0.6180 0.0778 65.5444);
            fill-opacity: 0.2;
            stroke: oklch(0.6180 0.0778 65.5444);
            stroke-width: 1px;
        }

        /* Test status */
        .test-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .test-status.pass {
            background: oklch(0.60 0.15 145);
            color: white;
        }

        .test-status.fail {
            background: oklch(0.5471 0.1438 32.9149);
            color: white;
        }

        .test-status.pending {
            background: oklch(0.70 0.15 85);
            color: black;
        }

        /* Instructions */
        .instructions {
            background: oklch(0.8348 0.0426 88.8064);
            padding: 16px;
            border-radius: 4px;
            margin: 20px 0;
        }

        .instructions h3 {
            margin-top: 0;
        }

        .instructions ul {
            margin: 8px 0;
            padding-left: 24px;
        }

        .instructions li {
            margin: 4px 0;
        }

        /* Keyboard shortcut display */
        kbd {
            display: inline-block;
            padding: 2px 6px;
            font-family: monospace;
            font-size: 0.875rem;
            background: oklch(0.3760 0.0225 64.3434);
            color: white;
            border-radius: 3px;
            margin: 0 2px;
        }

        /* Event log */
        .event-log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 12px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.875rem;
        }

        .event-log .event {
            margin: 4px 0;
            padding: 4px 8px;
            border-radius: 2px;
        }

        .event-log .event.keyboard {
            background: oklch(0.8348 0.0426 88.8064);
        }

        .event-log .event.focus {
            background: oklch(0.60 0.15 230);
            color: white;
        }

        .event-log .event.activate {
            background: oklch(0.60 0.15 145);
            color: white;
        }
    </style>
</head>
<body>
    <h1>Keyboard Navigation Test</h1>
    <p>Test comprehensive keyboard accessibility for bidirectional highlighting.</p>

    <!-- Instructions -->
    <div class="instructions">
        <h3>Test Instructions</h3>
        <ul>
            <li>Use <kbd>Tab</kbd> to navigate forward through chunks and bboxes</li>
            <li>Use <kbd>Shift</kbd> + <kbd>Tab</kbd> to navigate backward</li>
            <li>Use <kbd>Enter</kbd> or <kbd>Space</kbd> to activate (permanent highlight)</li>
            <li>Use <kbd>↑</kbd> <kbd>↓</kbd> to navigate chunks</li>
            <li>Use <kbd>←</kbd> <kbd>→</kbd> to navigate bboxes</li>
            <li>Use <kbd>Esc</kbd> to clear all highlights</li>
            <li>Use <kbd>/</kbd> to focus search input</li>
        </ul>
    </div>

    <!-- Test 1: Chunk Navigation -->
    <section class="test-section">
        <h2>Test 1: Chunk Navigation <span class="test-status pending" id="test1-status">PENDING</span></h2>
        <p>Test Tab navigation through chunks, arrow key navigation, and activation.</p>

        <div id="chunks-container">
            <div data-chunk-id="chunk-1" tabindex="0">
                <strong>Chunk 1:</strong> Introduction to Document Search
                <br><small>Section: Introduction | Page 1</small>
            </div>
            <div data-chunk-id="chunk-2" tabindex="0">
                <strong>Chunk 2:</strong> System Architecture Overview
                <br><small>Section: Architecture | Page 2</small>
            </div>
            <div data-chunk-id="chunk-3" tabindex="0">
                <strong>Chunk 3:</strong> ColPali Embedding Model
                <br><small>Section: Technical Details | Page 3</small>
            </div>
            <div data-chunk-id="chunk-4" tabindex="0">
                <strong>Chunk 4:</strong> ChromaDB Vector Storage
                <br><small>Section: Storage | Page 4</small>
            </div>
        </div>
    </section>

    <!-- Test 2: BBox Navigation -->
    <section class="test-section">
        <h2>Test 2: BBox Navigation <span class="test-status pending" id="test2-status">PENDING</span></h2>
        <p>Test Tab navigation through bounding boxes and arrow key navigation.</p>

        <svg class="bbox-overlay" id="bbox-container">
            <rect class="bbox-rect" data-bbox-id="bbox-1" x="20" y="20" width="200" height="80" tabindex="0" />
            <text x="30" y="50" fill="oklch(0.3760 0.0225 64.3434)">Section: Introduction</text>
            <text x="30" y="70" font-size="12" fill="oklch(0.5400 0.0400 71.1655)">Page 1</text>

            <rect class="bbox-rect" data-bbox-id="bbox-2" x="240" y="20" width="200" height="80" tabindex="0" />
            <text x="250" y="50" fill="oklch(0.3760 0.0225 64.3434)">Table: Performance Metrics</text>
            <text x="250" y="70" font-size="12" fill="oklch(0.5400 0.0400 71.1655)">Page 2</text>

            <rect class="bbox-rect" data-bbox-id="bbox-3" x="20" y="120" width="200" height="80" tabindex="0" />
            <text x="30" y="150" fill="oklch(0.3760 0.0225 64.3434)">Figure: Architecture</text>
            <text x="30" y="170" font-size="12" fill="oklch(0.5400 0.0400 71.1655)">Page 3</text>

            <rect class="bbox-rect" data-bbox-id="bbox-4" x="240" y="120" width="200" height="80" tabindex="0" />
            <text x="250" y="150" fill="oklch(0.3760 0.0225 64.3434)">Section: Conclusion</text>
            <text x="250" y="170" font-size="12" fill="oklch(0.5400 0.0400 71.1655)">Page 4</text>
        </svg>
    </section>

    <!-- Test 3: Global Shortcuts -->
    <section class="test-section">
        <h2>Test 3: Global Shortcuts <span class="test-status pending" id="test3-status">PENDING</span></h2>
        <p>Test Escape to clear highlights and / to focus search.</p>

        <div style="margin: 20px 0;">
            <input type="search" id="test-search" placeholder="Test search input" style="width: 100%; padding: 12px; font-size: 1rem;">
        </div>

        <button id="clear-test">Clear All (Esc)</button>
        <button id="focus-search-test">Focus Search (/)</button>
    </section>

    <!-- Test 4: Focus Indicators -->
    <section class="test-section">
        <h2>Test 4: Focus Indicators <span class="test-status pending" id="test4-status">PENDING</span></h2>
        <p>Verify focus indicators are visible and meet WCAG contrast requirements.</p>

        <div class="test-grid">
            <div>
                <h3>Chunk Focus</h3>
                <p>Focus should show 2-3px outline with proper contrast</p>
            </div>
            <div>
                <h3>BBox Focus</h3>
                <p>Focus should show 2-3px outline around SVG elements</p>
            </div>
        </div>
    </section>

    <!-- Test 5: No Keyboard Traps -->
    <section class="test-section">
        <h2>Test 5: No Keyboard Traps <span class="test-status pending" id="test5-status">PENDING</span></h2>
        <p>Ensure you can Tab through all elements and reach the browser address bar.</p>

        <p><strong>Test:</strong> Tab through all interactive elements on this page. You should be able to reach every element and eventually reach the browser chrome (address bar).</p>
    </section>

    <!-- Event Log -->
    <section class="test-section">
        <h2>Event Log</h2>
        <p>Monitor keyboard and focus events in real-time.</p>
        <div class="event-log" id="event-log">
            <div class="event">Event log ready. Start testing...</div>
        </div>
        <button id="clear-log">Clear Log</button>
    </section>

    <!-- Test Results Summary -->
    <section class="test-section">
        <h2>Test Results Summary</h2>
        <div id="test-summary">
            <p>Complete the tests above to see results.</p>
        </div>
    </section>

    <!-- Load test scripts -->
    <script type="module">
        // Import accessibility modules
        import { enableKeyboardNav, makeChunksFocusable, makeBoxesFocusable } from '../../src/frontend/accessibility/keyboard-nav.js';

        // Mock highlighter and overlay objects
        const mockHighlighter = {
            highlightChunk: (chunkId, permanent) => {
                logEvent(`highlightChunk(${chunkId}, permanent=${permanent})`, 'activate');
                const chunk = document.querySelector(`[data-chunk-id="${chunkId}"]`);
                if (chunk) {
                    if (permanent) {
                        chunk.classList.add('chunk-active');
                    } else {
                        chunk.classList.add('chunk-hover');
                    }
                }
            },
            clearHighlight: (chunkId) => {
                logEvent(`clearHighlight(${chunkId})`, 'keyboard');
                const chunk = document.querySelector(`[data-chunk-id="${chunkId}"]`);
                if (chunk) {
                    chunk.classList.remove('chunk-hover', 'chunk-active');
                }
            }
        };

        const mockOverlay = {
            container: document.getElementById('bbox-container'),
            highlightBbox: (bboxId, permanent) => {
                logEvent(`highlightBbox(${bboxId}, permanent=${permanent})`, 'activate');
                const bbox = document.querySelector(`[data-bbox-id="${bboxId}"]`);
                if (bbox) {
                    if (permanent) {
                        bbox.classList.add('active');
                    }
                }
            },
            clearHighlight: (bboxId) => {
                logEvent(`clearHighlight(${bboxId})`, 'keyboard');
                const bbox = document.querySelector(`[data-bbox-id="${bboxId}"]`);
                if (bbox) {
                    bbox.classList.remove('active');
                }
            }
        };

        // Event logging
        const eventLog = document.getElementById('event-log');
        let eventCount = 0;
        const maxEvents = 50;

        function logEvent(message, type = 'keyboard') {
            eventCount++;
            const event = document.createElement('div');
            event.className = `event ${type}`;
            event.textContent = `[${eventCount}] ${new Date().toLocaleTimeString()}: ${message}`;
            eventLog.insertBefore(event, eventLog.firstChild);

            // Limit log size
            if (eventLog.children.length > maxEvents) {
                eventLog.removeChild(eventLog.lastChild);
            }
        }

        // Clear log button
        document.getElementById('clear-log').addEventListener('click', () => {
            eventLog.innerHTML = '<div class="event">Event log cleared.</div>';
            eventCount = 0;
        });

        // Track keyboard events
        document.addEventListener('keydown', (e) => {
            const key = e.key;
            const modifiers = [];
            if (e.shiftKey) modifiers.push('Shift');
            if (e.ctrlKey) modifiers.push('Ctrl');
            if (e.altKey) modifiers.push('Alt');

            const keyDisplay = modifiers.length > 0 ? `${modifiers.join('+')}+${key}` : key;
            logEvent(`Key: ${keyDisplay}`, 'keyboard');
        });

        // Track focus events
        document.addEventListener('focusin', (e) => {
            const target = e.target;
            const id = target.id || target.dataset.chunkId || target.dataset.bboxId || target.tagName;
            logEvent(`Focus: ${id}`, 'focus');
        });

        // Enable keyboard navigation
        enableKeyboardNav(mockHighlighter, mockOverlay);

        // Test buttons
        document.getElementById('clear-test').addEventListener('click', () => {
            document.querySelectorAll('[data-chunk-id]').forEach(el => {
                el.classList.remove('chunk-hover', 'chunk-active');
            });
            document.querySelectorAll('.bbox-rect').forEach(el => {
                el.classList.remove('active');
            });
            logEvent('Manual clear triggered', 'activate');
        });

        document.getElementById('focus-search-test').addEventListener('click', () => {
            document.getElementById('test-search').focus();
            logEvent('Manual focus search triggered', 'activate');
        });

        // Test validation
        let test1Passed = false;
        let test2Passed = false;
        let test3Passed = false;

        // Test 1: Chunk navigation
        document.querySelectorAll('[data-chunk-id]').forEach(chunk => {
            chunk.addEventListener('focus', () => {
                test1Passed = true;
                updateTestStatus('test1-status', 'pass');
            });
        });

        // Test 2: BBox navigation
        document.querySelectorAll('.bbox-rect').forEach(bbox => {
            bbox.addEventListener('focus', () => {
                test2Passed = true;
                updateTestStatus('test2-status', 'pass');
            });
        });

        // Test 3: Global shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                test3Passed = true;
                updateTestStatus('test3-status', 'pass');
            }
        });

        function updateTestStatus(id, status) {
            const el = document.getElementById(id);
            el.className = `test-status ${status}`;
            el.textContent = status.toUpperCase();
            updateSummary();
        }

        function updateSummary() {
            const total = 5;
            const passed = [test1Passed, test2Passed, test3Passed].filter(Boolean).length;
            const summary = document.getElementById('test-summary');
            summary.innerHTML = `
                <p><strong>Tests Passed:</strong> ${passed} / ${total}</p>
                <p>Note: Tests 4 and 5 require manual verification.</p>
            `;
        }

        // Initialize summary
        updateSummary();
    </script>
</body>
</html>
